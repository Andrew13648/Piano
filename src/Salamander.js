import Tone from 'Tone/core/Tone'
import Buffer from 'Tone/core/Buffer'
import BufferSource from 'Tone/source/BufferSource'

const timeMapping = {'pedals': {'down': {'duration': 6.37530612244898, 'start': 2114.796961451247}, 'up': {'duration': 0.6948072562358276, 'start': 2121.172267573696}}, 'notes': {'60': [{'duration': 12.04514739229025, 'start': 855.9087528344671}, {'duration': 15.72734693877551, 'start': 899.1847845804989}, {'duration': 16.18562358276644, 'start': 914.9121315192743}, {'duration': 15.716689342403628, 'start': 867.9539002267574}, {'duration': 15.514195011337868, 'start': 883.670589569161}], '63': [{'duration': 13.350702947845805, 'start': 1371.2647619047618}, {'duration': 15.141179138321995, 'start': 1414.9990702947846}, {'duration': 15.817936507936508, 'start': 1430.1402494331066}, {'duration': 15.556825396825397, 'start': 1384.6154648526076}, {'duration': 14.826780045351473, 'start': 1400.1722902494332}], '66': [{'duration': 12.396848072562358, 'start': 1856.6803401360544}, {'duration': 13.137551020408162, 'start': 1898.5442403628117}, {'duration': 14.688231292517006, 'start': 1911.68179138322}, {'duration': 14.970657596371883, 'start': 1869.0771882086167}, {'duration': 14.496394557823129, 'start': 1884.0478458049886}], '69': [{'duration': 13.201496598639455, 'start': 388.5784807256236}, {'duration': 13.62780045351474, 'start': 430.4477097505669}, {'duration': 13.32297052154195, 'start': 444.07551020408164}, {'duration': 13.739705215419502, 'start': 401.77997732426303}, {'duration': 14.928027210884354, 'start': 415.51968253968255}], '81': [{'duration': 6.961473922902495, 'start': 457.3984807256236}, {'duration': 6.865555555555556, 'start': 485.3062811791383}, {'duration': 10.537120181405896, 'start': 492.1718367346939}, {'duration': 10.377256235827664, 'start': 464.35995464852607}, {'duration': 10.56907029478458, 'start': 474.7372108843537}], '87': [{'duration': 6.908185941043084, 'start': 1511.006485260771}, {'duration': 6.570907029478458, 'start': 1531.191700680272}, {'duration': 6.699478458049887, 'start': 1537.7626077097505}, {'duration': 6.821791383219955, 'start': 1517.9146712018141}, {'duration': 6.455238095238095, 'start': 1524.736462585034}], '84': [{'duration': 5.213628117913832, 'start': 1005.6419727891157}, {'duration': 5.442766439909297, 'start': 1023.2971428571428}, {'duration': 6.22609977324263, 'start': 1028.7399092970522}, {'duration': 6.252743764172336, 'start': 1010.8556009070295}, {'duration': 6.188798185941043, 'start': 1017.1083446712018}], '24': [{'duration': 23.864421768707484, 'start': 552.7069841269841}, {'duration': 23.60331065759637, 'start': 623.5648752834467}, {'duration': 23.619297052154195, 'start': 647.1681859410431}, {'duration': 23.523378684807255, 'start': 576.5714058956916}, {'duration': 23.470090702947846, 'start': 600.0947845804989}], '27': [{'duration': 19.04718820861678, 'start': 1073.103537414966}, {'duration': 22.06328798185941, 'start': 1140.4444217687076}, {'duration': 24.274739229024945, 'start': 1162.5077097505668}, {'duration': 24.018956916099775, 'start': 1092.1507256235827}, {'duration': 24.274739229024945, 'start': 1116.1696825396825}], '21': [{'duration': 21.114761904761906, 'start': 0.0}, {'duration': 24.77031746031746, 'start': 72.66904761904762}, {'duration': 24.999455782312925, 'start': 97.43936507936507}, {'duration': 25.691655328798188, 'start': 21.114761904761906}, {'duration': 25.862630385487527, 'start': 46.80641723356009}], '48': [{'duration': 15.87122448979592, 'start': 776.0943537414965}, {'duration': 15.860566893424036, 'start': 824.0490702947845}, {'duration': 15.999115646258504, 'start': 839.9096371882086}, {'duration': 15.807278911564627, 'start': 791.9655782312925}, {'duration': 16.276213151927436, 'start': 807.7728571428571}], '45': [{'duration': 16.0897052154195, 'start': 232.49866213151927}, {'duration': 16.19628117913832, 'start': 281.03954648526076}, {'duration': 15.935170068027212, 'start': 297.2358276643991}, {'duration': 16.16963718820862, 'start': 248.58836734693878}, {'duration': 16.28154195011338, 'start': 264.7580045351474}], '42': [{'duration': 17.347301587301587, 'start': 1679.3013151927437}, {'duration': 19.51079365079365, 'start': 1737.6685034013606}, {'duration': 20.448662131519274, 'start': 1757.1792970521542}, {'duration': 20.374058956916098, 'start': 1696.6486167800454}, {'duration': 20.645827664399093, 'start': 1717.0226757369614}], '105': [{'duration': 2.6238321995464853, 'start': 534.8771655328799}, {'duration': 3.8547845804988663, 'start': 544.8268934240363}, {'duration': 4.0253061224489795, 'start': 548.6816780045351}, {'duration': 3.7695238095238097, 'start': 537.5009977324263}, {'duration': 3.5563718820861676, 'start': 541.2705215419501}], '75': [{'duration': 12.471451247165533, 'start': 1445.958185941043}, {'duration': 12.972358276643991, 'start': 1485.0884126984126}, {'duration': 12.945714285714285, 'start': 1498.0607709750566}, {'duration': 13.37734693877551, 'start': 1458.4296371882085}, {'duration': 13.281428571428572, 'start': 1471.8069841269842}], '78': [{'duration': 11.171224489795918, 'start': 1926.370022675737}, {'duration': 11.634829931972789, 'start': 1961.290498866213}, {'duration': 11.911927437641724, 'start': 1972.925328798186}, {'duration': 11.752063492063492, 'start': 1937.541247165533}, {'duration': 11.99718820861678, 'start': 1949.2933106575963}], '99': [{'duration': 5.053764172335601, 'start': 1544.4620861678004}, {'duration': 4.829954648526077, 'start': 1559.6660090702949}, {'duration': 4.872585034013605, 'start': 1564.4959637188208}, {'duration': 5.027120181405896, 'start': 1549.515850340136}, {'duration': 5.1230385487528345, 'start': 1554.542970521542}], '108': [{'duration': 3.098095238095238, 'start': 1056.0783673469389}, {'duration': 2.8103401360544216, 'start': 1066.411768707483}, {'duration': 3.8814285714285712, 'start': 1069.2221088435374}, {'duration': 3.5936734693877552, 'start': 1059.176462585034}, {'duration': 3.6416326530612246, 'start': 1062.7701360544218}], '72': [{'duration': 13.403990929705216, 'start': 931.0977551020408}, {'duration': 15.333015873015873, 'start': 974.7414739229025}, {'duration': 15.56748299319728, 'start': 990.0744897959183}, {'duration': 15.514195011337868, 'start': 944.501746031746}, {'duration': 14.725532879818594, 'start': 960.0159410430839}], '102': [{'duration': 4.835283446712018, 'start': 2012.6212698412699}, {'duration': 4.755351473922903, 'start': 2026.75410430839}, {'duration': 4.829954648526077, 'start': 2031.509455782313}, {'duration': 4.79265306122449, 'start': 2017.456553287982}, {'duration': 4.5048979591836735, 'start': 2022.2492063492064}], '90': [{'duration': 4.297074829931973, 'start': 1984.8372562358277}, {'duration': 5.533356009070295, 'start': 2001.2401587301588}, {'duration': 5.847755102040816, 'start': 2006.773514739229}, {'duration': 6.124852607709751, 'start': 1989.1343310657596}, {'duration': 5.980975056689342, 'start': 1995.2591836734694}], '93': [{'duration': 5.453424036281179, 'start': 502.7089569160998}, {'duration': 6.343219954648526, 'start': 521.7270068027211}, {'duration': 6.806938775510204, 'start': 528.0702267573696}, {'duration': 6.731043083900227, 'start': 508.16238095238094}, {'duration': 6.83358276643991, 'start': 514.8934240362812}], '96': [{'duration': 4.137210884353742, 'start': 1034.9660090702948}, {'duration': 4.051950113378685, 'start': 1047.9478231292517}, {'duration': 4.07859410430839, 'start': 1051.9997732426305}, {'duration': 4.483582766439909, 'start': 1039.1032199546485}, {'duration': 4.361020408163266, 'start': 1043.5868027210884}], '39': [{'duration': 18.913968253968253, 'start': 1186.782448979592}, {'duration': 22.233809523809523, 'start': 1249.8549659863945}, {'duration': 22.105918367346938, 'start': 1272.0887755102042}, {'duration': 21.940725623582768, 'start': 1205.6964172335602}, {'duration': 22.217823129251702, 'start': 1227.6371428571429}], '33': [{'duration': 20.192879818594104, 'start': 122.43882086167801}, {'duration': 19.765759637188207, 'start': 189.42800453514738}, {'duration': 23.304897959183673, 'start': 209.1937641723356}, {'duration': 23.39015873015873, 'start': 142.6317006802721}, {'duration': 23.406145124716552, 'start': 166.02185941043084}], '54': [{'duration': 15.498208616780046, 'start': 1777.6279591836735}, {'duration': 16.07371882086168, 'start': 1824.4796145124717}, {'duration': 16.127006802721088, 'start': 1840.5533333333333}, {'duration': 15.940498866213153, 'start': 1793.1261678004535}, {'duration': 15.412947845804988, 'start': 1809.0666666666666}], '57': [{'duration': 13.01498866213152, 'start': 313.1709977324263}, {'duration': 15.578140589569161, 'start': 357.38489795918366}, {'duration': 15.615442176870749, 'start': 372.9630385487528}, {'duration': 15.311700680272109, 'start': 326.1859863945578}, {'duration': 15.887210884353742, 'start': 341.4976870748299}], '30': [{'duration': 16.713174603174604, 'start': 1569.3685487528344}, {'duration': 23.251609977324264, 'start': 1632.7021768707482}, {'duration': 23.3475283446712, 'start': 1655.9537868480725}, {'duration': 23.3475283446712, 'start': 1586.081723356009}, {'duration': 23.272925170068028, 'start': 1609.4292517006802}], '51': [{'duration': 13.116235827664399, 'start': 1294.1946938775511}, {'duration': 15.924512471655328, 'start': 1339.261201814059}, {'duration': 16.079047619047618, 'start': 1355.1857142857143}, {'duration': 15.844580498866213, 'start': 1307.3109297052154}, {'duration': 16.105691609977324, 'start': 1323.1555102040816}], '36': [{'duration': 18.668843537414965, 'start': 670.7874829931973}, {'duration': 19.7181179138322, 'start': 734.0571655328798}, {'duration': 22.31907029478458, 'start': 753.775283446712}, {'duration': 22.281768707482993, 'start': 689.4563265306123}, {'duration': 22.31907029478458, 'start': 711.7380952380952}]}, 'hammers': {'60': {'duration': 0.45501133786848075, 'start': 2107.1161904761907}, '63': {'duration': 0.45501133786848075, 'start': 2107.571201814059}, '66': {'duration': 0.45501133786848075, 'start': 2108.0262131519275}, '69': {'duration': 0.45501133786848075, 'start': 2108.4812244897957}, '81': {'duration': 0.45501133786848075, 'start': 2110.30126984127}, '87': {'duration': 0.45501133786848075, 'start': 2111.2112925170068}, '84': {'duration': 0.45501133786848075, 'start': 2110.756281179138}, '24': {'duration': 0.45501133786848075, 'start': 2101.6560544217687}, '27': {'duration': 0.45501133786848075, 'start': 2102.1110657596373}, '21': {'duration': 0.45501133786848075, 'start': 2101.2010430839}, '48': {'duration': 0.45501133786848075, 'start': 2105.2961451247165}, '108': {'duration': 0.45501133786848075, 'start': 2114.3419501133785}, '45': {'duration': 0.45501133786848075, 'start': 2104.841133786848}, '42': {'duration': 0.45501133786848075, 'start': 2104.3861224489797}, '105': {'duration': 0.45501133786848075, 'start': 2113.8869387755103}, '96': {'duration': 0.40058956916099775, 'start': 2112.5763265306123}, '99': {'duration': 0.45501133786848075, 'start': 2112.9769160997735}, '75': {'duration': 0.45501133786848075, 'start': 2109.391247165533}, '72': {'duration': 0.45501133786848075, 'start': 2108.9362358276644}, '102': {'duration': 0.45501133786848075, 'start': 2113.4319274376417}, '90': {'duration': 0.45501133786848075, 'start': 2111.6663038548754}, '93': {'duration': 0.45501133786848075, 'start': 2112.1213151927436}, '78': {'duration': 0.45501133786848075, 'start': 2109.8462585034013}, '39': {'duration': 0.45501133786848075, 'start': 2103.931111111111}, '33': {'duration': 0.45501133786848075, 'start': 2103.021088435374}, '54': {'duration': 0.45501133786848075, 'start': 2106.2061678004534}, '57': {'duration': 0.45501133786848075, 'start': 2106.661179138322}, '30': {'duration': 0.45501133786848075, 'start': 2102.5660770975055}, '51': {'duration': 0.45501133786848075, 'start': 2105.751156462585}, '36': {'duration': 0.45501133786848075, 'start': 2103.476099773243}}, 'harmonics': {'60': {'duration': 2.836984126984127, 'start': 2061.7337188208617}, '63': {'duration': 2.831655328798186, 'start': 2078.622403628118}, '66': {'duration': 2.7730385487528344, 'start': 2095.5697052154196}, '69': {'duration': 2.842312925170068, 'start': 2047.5967573696146}, '81': {'duration': 2.874285714285714, 'start': 2050.4390702947844}, '87': {'duration': 2.7783673469387753, 'start': 2084.301700680272}, '84': {'duration': 2.7730385487528344, 'start': 2067.3490702947847}, '24': {'duration': 2.815668934240363, 'start': 2053.3133560090705}, '27': {'duration': 2.815668934240363, 'start': 2070.1221088435373}, '21': {'duration': 2.7783673469387753, 'start': 2036.339410430839}, '48': {'duration': 2.7890249433106575, 'start': 2058.944693877551}, '45': {'duration': 2.85297052154195, 'start': 2041.9814058956915}, '42': {'duration': 2.868956916099773, 'start': 2089.911723356009}, '75': {'duration': 2.847641723356009, 'start': 2081.454058956916}, '72': {'duration': 2.7783673469387753, 'start': 2064.570702947846}, '78': {'duration': 2.858299319727891, 'start': 2098.342743764172}, '39': {'duration': 2.8636281179138323, 'start': 2072.9377777777777}, '33': {'duration': 2.8636281179138323, 'start': 2039.1177777777777}, '54': {'duration': 2.7890249433106575, 'start': 2092.780680272109}, '57': {'duration': 2.762380952380952, 'start': 2044.8343764172337}, '30': {'duration': 2.831655328798186, 'start': 2087.080068027211}, '51': {'duration': 2.820997732426304, 'start': 2075.8014058956915}, '36': {'duration': 2.815668934240363, 'start': 2056.1290249433105}}}

function midiToNote(midi){
	let mod = midi % 3
	if (mod === 1){
		return [midi - 1, Tone.prototype.intervalToFrequencyRatio(1)]
	} else if (mod === 2){
		return [midi + 1, Tone.prototype.intervalToFrequencyRatio(-1)]
	} else {
		return [midi, 1]
	}
}

function clone(obj){
	let ret = {}
	for (let attr in obj){
		ret[attr] = obj[attr]
	}
	return ret
}

export default {

	velocityCount : timeMapping.notes['21'].length,

	buffer : null,

	newSource(){
		return new BufferSource(this.buffer)
	},

	load(url){
		return new Promise((success) => {
			this.buffer = new Buffer(url, success)
		})
	},

	getNote(midi, velocity){
		let [note, rate] = midiToNote(midi)
		let timing = clone(timeMapping.notes[note][velocity])
		timing.duration /= rate
		return {timing, rate}
	},

	getPedal(direction){
		return clone(timeMapping.pedals[direction])
	},

	hasHarmonics(midi){
		let [note, rate] = midiToNote(midi)
		return timeMapping.harmonics.hasOwnProperty(note)
	},

	getHarmonics(midi){
		let [note, rate] = midiToNote(midi)
		let timing = clone(timeMapping.harmonics[note])
		timing.duration /= rate
		return {timing, rate}
	},

	getRelease(midi){
		let [note, rate] = midiToNote(midi)
		let timing = clone(timeMapping.hammers[note])
		timing.duration /= rate
		return {timing, rate}
	}
}